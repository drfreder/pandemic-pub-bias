---
title: "The COVID-19 pandemic's gendered impact on academic productivity"
author: "Megan Frederickson"
date: "18/04/2020"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# How is COVID-19 affecting the productivity of male versus female academics?

There is debate on Twitter about how the COVID-19 pandemic is affecting submissions to journals, and expecially whether there are differences between male and female scholars.

Anecdotally, journal editors have observed that submissions from female scholars are down in March and April, 2020, presumably because women are disproportionately shouldering increased caregiving burdens during the pandemic, especially in the face of school and childcare closures. Is this borne out by the data? 

I do not have access to journal submission data directly, so I used data from large preprint servers, where academics often archive their papers as they submit them for peer-review to journals.

```{r Load packages, message=FALSE, warning=FALSE, include=FALSE}

#Load packages
library(tidyverse) #includes ggplot2, dplyr, readr, stringr
library(knitr)
library(cowplot)
library(gender)
library(aRxiv)
library(rbiorxiv)
library(lubridate)
library(anytime)
library(wesanderson)

```

## arXiv submissions

First, I scraped submission data from arXiv (https://arxiv.org/), which is the main preprint server for physics, math, computer science, statistics, and other quantitative disciplines. I scraped all records for March 15-April 15, 2020, during the COVID-19 pandemic, and for the same date range in 2019. I scraped the data in batches, as recommended in the aRxiv package tutorial. 

```{r Scrape arxiv, eval=FALSE}
#Not run
#Get all submissions between March 15, 2020 and April 15, 2020 (during the COVID-19 pandemic)
n.2020 <- arxiv_count(query = 'submittedDate:[20200315 TO 20200415]')
df.2020.1 <- arxiv_search(query = 'submittedDate:[20200315 TO 20200321]', limit=n.2020, batchsize=1000)
df.2020.2 <- arxiv_search(query = 'submittedDate:[20200322 TO 20200328]', limit=n.2020, batchsize=1000)
df.2020.3 <- arxiv_search(query = 'submittedDate:[20200329 TO 20200403]', limit=n.2020, batchsize=1000)
df.2020.4 <- arxiv_search(query = 'submittedDate:[20200404 TO 20200409]', limit=n.2020, batchsize=1000)
df.2020.5 <- arxiv_search(query = 'submittedDate:[20200410 TO 20200412]', limit=2000, batchsize=500)
df.2020.6 <- arxiv_search(query = 'submittedDate:[20200413 TO 20200415]', limit=2000, batchsize=500)
df.2020.full <- rbind(df.2020.1, df.2020.2, df.2020.3, df.2020.4, df.2020.5, df.2020.6)
write.csv(df.2020.full, file="arxiv_2020_data.csv")

#Get all submission between March 15, 2019 and April 15, 2019 (the same dates last year)
n.2019 <- arxiv_count(query = 'submittedDate:[20190315 TO 20190415]')
df.2019.1 <- arxiv_search(query = 'submittedDate:[20190315 TO 20190322]', limit=n.2019, batchsize=1000)
df.2019.2 <- arxiv_search(query = 'submittedDate:[20190323 TO 20190329]', limit=n.2019, batchsize=1000)
df.2019.3 <- arxiv_search(query = 'submittedDate:[20190330 TO 20190405]', limit=n.2019, batchsize=1000)
df.2019.4 <- arxiv_search(query = 'submittedDate:[20190406 TO 20190412]', limit=n.2019, batchsize=1000)
df.2019.5 <- arxiv_search(query = 'submittedDate:[20190413 TO 20190415]', limit=n.2019, batchsize=500)
df.2019.full <- rbind(df.2019.1, df.2019.2, df.2019.3, df.2019.4, df.2019.5)
write.csv(df.2019.full, file="arxiv_2019_data.csv")

```

I then tidied the data by splitting strings of author names to identify the first and last author of each preprint. 

```{r Tidy author names}

df.2020 <- read.csv("arxiv_2020_data.csv") #Read in data
df.2019 <- read.csv("arxiv_2019_data.csv")

n.2020 <- length(df.2020$id) #Number of preprints 2020
n.2019 <- length(df.2019$id) #Number of preprints 2019

df.full <- rbind(df.2019, df.2020) #Combine in one dataframe

df.full$author.n <- str_count(df.full$authors, pattern = "\\|")+1 #Count author number
max(df.full$author.n) #Max author number 
df.full$first.author <- sapply(strsplit(as.character(df.full$authors), "|", fixed=TRUE), head, 1) #Extract first author 
df.full$last.author <- sapply(strsplit(as.character(df.full$authors), "|", fixed=TRUE), tail, 1) #Extract last author

df.full$first.author.first.name <- sapply(strsplit(df.full$first.author, " "), head, 1) #Extract first author first name
df.full$last.author.first.name <- sapply(strsplit(df.full$last.author, " "), head, 1) #Extract last author first name

df.full$year <- as.factor(year(as.Date(df.full$submitted))) #Extract year

```

I assigned gender to author first names using the gender package (https://github.com/ropensci/gender). This package returns the probability that a name is male or female by comparing the name to a names in a database; I used the U.S. Social Security baby names database. 

Please note: this is a brute force and rather crude method of predicting gender, and it has many limitations, as discussed by the package authors on their GitHub repo and included links. By using this method, I am not assuming that individuals are correctly gendered in the resulting dataset, but merely that it provides insight into gender's effects in aggregate across the population of preprint authors. 

I started by assigning gender to first and last authors of preprints.

```{r Assign first and last author gender}

gender <- NULL
gender <- gender(df.full$first.author.first.name, method = "ssa")
gender <- unique(gender[ , c(1,2,4)])
df.full <- merge(df.full, gender, by.x = "first.author.first.name",  by.y ="name", all = TRUE)
colnames(df.full)[which(colnames(df.full) == "proportion_male")] <- "first.author.prop.male"
colnames(df.full)[which(colnames(df.full) == "gender")] <- "first.author.gender"

gender <- gender(df.full$last.author.first.name, method = "ssa")
gender <- unique(gender[ , c(1,2,4)])
df.full <- merge(df.full, gender, by.x = "last.author.first.name",  by.y ="name", all = TRUE)
colnames(df.full)[which(colnames(df.full) == "proportion_male")] <- "last.author.prop.male"
colnames(df.full)[which(colnames(df.full) == "gender")] <- "last.author.gender"

```

Next, I predicted the genders of ALL preprint authors, and summarized the data as the number of male and female authors of each preprint, regardless of order. This code takes a while to run, so it is not run when knitting this markdown document.

```{r, Assign all authors gender, eval=FALSE}

#Not run
split.names <- function(x){strsplit(as.character(x), "|", fixed=TRUE)}  
df.full$split.names <- lapply(df.full$authors, split.names)

tmp <- NULL
for(i in 1:length(df.full$authors)){
  tmp[i] <- as.vector(gender(word(unlist(df.full$split.names[[i]]), 1), method="ssa")[, 4])
  df.full$male.n[i] <- as.numeric(str_count(as.character(tmp[i]), pattern = paste(sprintf("\\b%s\\b", "male"))))
  df.full$female.n[i] <- as.numeric(str_count(as.character(tmp[i]), pattern = paste(sprintf("\\b%s\\b", "female"))))
}

df.full.output <- as.data.frame(apply(df.full,2,as.character))
write.csv(df.full.output, "arxiv_full_gender.csv")

```

#All arXiv authors

I calculated how many male and female authors there were on arXiv preprints in 2020 versus 2019. 

```{r Visualize data, fig.width=8, fig.height=4, dpi=300}

df.full <- read_csv("arxiv_full_gender.csv")

all <- df.full %>% group_by(year) %>% summarize(Female = sum(female.n, na.rm=TRUE), Male = sum(male.n, na.rm=TRUE))
all$total <- all$Female+all$Male
all.long <- gather(all, Gender, number, Male:Female)
all.t <- as.data.frame(t(all[,-1]))
colnames(all.t) <- c("2019", "2020")
all.t$per.dif <- (all.t$`2020`/all.t$`2019`*100)-100

p1 <- ggplot(data=all.long, aes(fill=as.factor(year), y=number, x=Gender))+geom_bar(position="dodge", stat="identity")+theme_cowplot()+xlab("Gender")+ylab("Authors (no.)")+labs(fill="Year")+scale_fill_manual(values = wes_palette("Royal1"), labels=c("Mar/Apr 2019", "Mar/Apr 2020"))+annotate("text", x=c(1,2),  y=c(6800,23900), label = paste0("+", round(all.t$per.dif[1:2], 1), "%"))+ggtitle("arXiv: all authors")+theme(legend.position = c(0.1, 0.9), legend.title = element_blank(), plot.title = element_text(hjust = 0.5))
p1

```

### Sole arXiv authors

How many preprints were sole-authored by a male versus a female academic in Mar/Apr, 2020, compared to the same dates last year? 

```{r Sole authors, fig.width=8, fig.height=4, dpi=300}

summary <- df.full %>% group_by(year, male.n, female.n) %>% summarize(n = n())
summary$total.n <- summary$male.n+summary$female.n
summary.sole.authors <- subset(summary, total.n == 1)
sole.wide <- spread(summary.sole.authors, year, n)
sole.wide$gender <- ifelse(sole.wide$male.n == 0, "Female", "Male")
sole.long <- gather(sole.wide, year, number, `2019`:`2020`)
sole.wide$per.dif <- (sole.wide$`2020`/sole.wide$`2019`)*100-100

p2 <- ggplot(data=sole.long, aes(fill=as.factor(year), y=number, x=gender))+geom_bar(position="dodge", stat="identity")+theme_cowplot()+xlab("Gender")+ylab("Authors (no.)")+labs(fill="Year")+scale_fill_manual(values = wes_palette("Royal1"))+annotate("text", x=c(1,2),  y=c(680,2600), label = paste0("+", round(sole.wide$per.dif, 1), "%"))+ggtitle("arXiv: sole authors")+theme(legend.position = "none", plot.title = element_text(hjust = 0.5))
p2

```

## bioRxiv submissions

Next, I scraped submission data from bioRxiv (https://biorxiv.org/), which is the main preprint server for biology. I scraped all records for March 15-April 15, 2020, during the COVID-19 pandemic, and for the same date range in 2019.

```{r Scrape biorxiv, eval=FALSE}

#Not run
#Get all submissions between March 15, 2020 and April 15, 2020 (during the COVID-19 pandemic)
df.b.2020 <- biorxiv_content(from = "2020-03-15", to = "2020-04-15", limit = "*", format = "df")

df.b.2019 <- biorxiv_content(from = "2019-03-15", to = "2019-04-15", limit = "*", format = "df")

write.csv(df.b.2019, "biorxiv_2019_data.csv")
write.csv(df.b.2020, "biorxiv_2020_data.csv")

```

I then inferred the gender of corresponding authors, as above. Note that the bioRxiv api only returns first author names for the corresponding authors, and not for all authors. (Unfortunately.)

```{r bioRxiv gender}

df.b.2019 <- read_csv("biorxiv_2019_data.csv")
df.b.2020 <- read_csv("biorxiv_2020_data.csv")
df.b.full <- rbind(df.b.2019, df.b.2020)

df.b.full$cor.author.first.name <- sapply(strsplit(df.b.full$author_corresponding, " "), head, 1) #Extract first names

gender <- NULL
gender <- gender(df.b.full$cor.author.first.name, method = "ssa")
gender <- unique(gender[ , c(1,2,4)])
df.b.full <- merge(df.b.full, gender, by.x = "cor.author.first.name",  by.y ="name", all = TRUE)

df.b.full$year <- as.factor(year(as.Date(df.b.full$date))) #Extract year

```

Finally, I plot the numbers of male and female corresponding authors on bioRxiv preprints between Mar/Apr 2019 and Mar/Apr 2020. 

```{r Visualize biorxiv data, fig.width=8, fig.height=4, dpi=300}

summary <- subset(df.b.full, !is.na(gender)) %>% group_by(year, gender) %>% summarize(n = n())
summary.wide <- spread(summary, year, n)
summary.wide$gender <- as.factor(summary.wide$gender)
levels(summary.wide$gender) <- c("Female", "Male")
summary.long <- gather(summary.wide, year, number, `2019`:`2020`)
summary.wide$per.dif <- (summary.wide$`2020`/summary.wide$`2019`*100)-100

p3 <- ggplot(data=summary.long, aes(fill=as.factor(year), y=number, x=gender))+geom_bar(position="dodge", stat="identity")+theme_cowplot()+xlab("Gender")+ylab("Authors (no.)")+labs(fill="Year")+scale_fill_manual(values = wes_palette("Royal1"))+annotate("text", x=c(1,2),  y=c(1100,2650), label = paste0("+", round(summary.wide$per.dif), "%"))+ggtitle("bioRxiv: corresponding authors")+theme(legend.position = "none", plot.title = element_text(hjust = 0.5))
p3

p4 <- plot_grid(p1, p2, p3, nrow=1)
save_plot("plot.png", p4, base_height=8, base_width=16)

```

